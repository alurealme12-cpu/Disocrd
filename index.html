<html>
  <body>
    <script src="https://js.puter.com/v2/"></script>
    <script>
      async function main() {
        // 1. Get email data (passed from Apps Script via query params)
        const params = new URLSearchParams(window.location.search);
        const subject = params.get("subject") || "No Subject";
        const body = params.get("body") || "No Content";

        // 2. Use puter to generate PNG screenshot-style
        const img = await puter.ai.txt2img(
          `Create a clean screenshot-style PNG of an email.
           Subject: ${subject}
           Body: ${body}`
        );

        // 3. Convert <img> element â†’ Blob (so we can upload to Discord)
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const blob = await new Promise(r => canvas.toBlob(r, "image/png"));

        // 4. Upload to Discord webhook
        const form = new FormData();
        form.append("file", blob, "email.png");
        form.append("payload_json", JSON.stringify({
          content: `ðŸ“§ New Email: **${subject}**`
        }));

        await fetch("https://discord.com/api/webhooks/1409312040224428175/_H8_p1_Yn7towbn4zyxL_L6JQB47DqjGK4Qsh5UGknX6Nqwo_J54w-QoT4MKkuKnk3g5", {
          method: "POST",
          body: form
        });
      }

      main();
    </script>
  </body>
</html>
